# ==Surge.conf==
# @ConfigName     Surge配置文件
# @Author         Chris
# @UpdateTime     2023/05/25 12:00 UTC/GMT +8
# @Version        1.0
# @ConfigURL      
# @Description    Surge VIF 虚拟网卡(Virtual Network Interface, 简写为VIF)

# Changelog
# [+]2023-05-23 1.初始化配置文件
# [+]2023-05-25 2.优化代理和策略组
# [+]2023-05-30 3.整理注释

[General]
# ---通用---
# > 网络优化
# - 并发 DNS 查询
# - Optimistic DNS
# - TCP CDN 优化
# - 增强版 Wi-Fi 助理
# 在 Wi-Fi 网络不佳时尝试使用数据网络建立连接,请仅当使用不限量的数据流量时开启
wifi-assist = false
# - 混合网络
all-hybrid = false
# - 游戏优化
# 开启后将在系统负载非常高,数据包处理出现延迟时,优先处理 UDP 数据包
udp-priority = false

# > 延迟测试
# - INTERNET 测试 URL
# 使用网络诊断功能时访问的 URL
internet-test-url = http://wifi.vivo.com.cn/generate_204
# - 代理测速 URL
# 测试代理策略时的 URL
proxy-test-url = http://cp.cloudflare.com/generate_204
# - 测试超时(秒)
# Surge 将向该 URL 发送一个 HTTP HEAD 请求测试只关心是否收到了返回数据,并不关心数据内容
# 仅支持 http:// 协议
test-timeout = 3

# > 子网设置覆盖

# > GeoIP 数据库
# - 自定义 GEOIP 数据库 URL
geoip-maxmind-url = https://github.com/Hackl0us/GeoIP2-CN/raw/release/Country.mmdb

# > IPv6
# - IPv6
ipv6 = false
# - IPv6 VIF
# 允许 IPv6 通过 Surge VIF当希望 Surge 处理连接到 IPv6 地址的原始 TCP 连接时非常有用
# true / false / auto / always
# ipv6-vif = auto

# ---Wi-Fi 访问---
# > 允许 Wi-Fi 访问
# 仅 ios,若允许远程访问将 false 改为 true
allow-wifi-access = false
# > 允许个人热点访问
allow-hotspot-access = false
# > HTTP 代理服务端口
wifi-access-http-port = 6152
# > SOCKS5 代理服务端口
wifi-access-socks5-port = 6153
# > 允许 Wi-Fi 访问
# 仅 macos,若允许远程访问将 127.0.0.1 改为 0.0.0.0
http-listen = 0.0.0.0
socks5-listen = 0.0.0.0

# ---远程控制器---
# > 远程控制器
# - 远程控制器
# - 端口 密码
external-controller-access = chris@127.0.0.1:6170
# - 允许由 Wi-Fi 控制
# > HTTP API & Web 控制器
# - HTTP API
# HTTP API 可以让另一个 App 或者设备通过 HTTP API 控制 Surge 功能
http-api-tls = false
# - 端口 密码
http-api = chris@127.0.0.1:6166
# - 允许由 Wi-Fi 控制
# - HTTPS
# - Web 控制器
http-api-web-dashboard = false

# ---兼容性---
# > 兼容模式
# 仅 ios, 默认禁用
compatibility-mode = 0
# > 跳过代理
# 该选项将使得发往这些域名或者 IP 段的请求由 Surge VIF 进行处理(而不是 Surge Proxy),该选项用于修正和某些应用的兼容性问题该选项一般只用于处理某些特殊的兼容性问题, 并不能使请求绕过 Surge(对于 Surge Mac, 如果未开启 增强模式,确实可以绕过)
skip-proxy = 127.0.0.1/32, 192.168.0.0/16, 10.0.0.0/8, 172.16.0.0/12, 100.64.0.0/10, 169.254.0.0/16, 192.168.122.1/32, 193.168.0.1/32, 224.0.0.0/4, 240.0.0.0/4, 255.255.255.255/32, localhost, *.local, *.crashlytics.com, passenger.t3go.cn, captive.apple.com, seed-sequoia.siri.apple.com, sequoia.apple.com, injections.adguard.org, local.adguard.org
# > 排除简单主机名
# 仅 macos
exclude-simple-hostnames = true

# ---路由---
# > 包含所有网络请求
# 强制所有网络数据由 Surge 处理,在未开启的情况下,网络切换时的网络请求有可能不被 Surge 处理,app 也可以通过强制绑定物理网络适配器的方式绕过
# 开启后所有除本地局域网外的网络流量一定都将由 Surge 所处理, 不可绕过
include-all-networks = false
# > 包含本地网络请求
# include-local-networks 仅在 include-all-networks 开启时有效,将无视路由表,将所有本地流量也交由 Surge 所处理
include-local-networks = false

# [高级]
# > 日志等级
loglevel = notify
# > Show Reject Error Page
# 当遇到REJECT策略时返回错误页
show-error-page-for-reject = true
# > Always Real IP Hosts
# 当Surge VIF处理DNS问题时,要求Surge返回真实IP地址
always-real-ip = *.msftconnecttest.com,*.msftncsi.com,  *.srv.nintendo.net, *.stun.playstation.net, xbox.*.microsoft.com, *.xboxlive.com, stun.l.google.com
# > Hijack DNS
# hijack-dns = *:53
hijack-dns = 8.8.8.8:53, 8.8.4.4:53
# > TCP Force HTTP Hosts
# 让 Surge 把 TCP 连接当作 HTTP 请求来处理
# Surge HTTP 引擎将处理这些请求
# 所有的高级功能,如捕获,重写和脚本等都可以使用
# force-http-engine-hosts = *.ott.cibntv.net, 123.59.31.1,119.18.193.135, 122.14.246.33, 175.102.178.52, 116.253.24.*, 175.6.26.*, 220.169.153.*
# 仅适用于 Surge VIF
# > VIF Excluded Routes
# Surge VIF 只能处理 TCP 和 UDP 协议
# 使用此选项绕过特定的 IP 范围,以允许所有流量通过
# tun-excluded-routes = 239.255.255.250/32
# > VIF Included Routes
# 由于 Wi-Fi 接口的路由较小,一些流量可能无法通过 Surge VIF 接口
# 添加较小的路由
# tun-included-routes = 192.168.1.12/32
# 当 Wi-Fi 不是首选网络时 SSID 组策略使用默认策略
use-default-policy-if-wifi-not-primary = false

# [DNS]
# > DNS 服务器
# > 自定义 DNS 服务器
# 如无必要不建议使用DNS over HTTPS
dns-server = system, 119.29.29.29, 119.28.28.28, 223.5.5.5, 223.6.6.6, 1.2.4.8, 8.8.8.8
# > 加密 DNS
# 如果配置了加密 DNS, 传统 DNS 将仅用作解析 DOH 域名和测试网络连通性
# 支持的协议
# DNS over HTTPS: https://doh.pub/dns-query
# DNS over HTTP/3: h3://example.com
# DNS over QUIC: quic://example.com
# 除非当地 ISP 有严重的 DNS 污染问题,否则没必要开启 DoH,传统 DNS 的性能最优,网络异常后恢复速度最快
# encrypted-dns-server = https://doh.pub/dns-query
# > 关闭 DOH 的服务端证书验证
# 关闭 DOH 的服务端证书验证(解决 Surge 无法与 nextdns.io 完成 TLS 握手问题)
# doh-skip-cert-verification=true
# > 代理请求本地 DNS 映射
# 开启该选项后, 如果访问的域名配置有本地 DNS 映射,surge 将使用本地 IP 地址进行请求,不在远端进行解析仅对配置了 IP 地址的本地 DNS 映射生效
# use-local-host-item-for-proxy = true
# > 使加密 DNS 请求通过代理策略执行
# encrypted-dns-follow-outbound-mode = false
# > Surge Private DDNS
# > 代理请求本地 DNS 映射
# > 仅 macos 从 /etc/hosts 读取 DNS 记录
read-etc-hosts = true

# [其他]
# > 隐藏 VPN 图标
hide-vpn-icon = false
# 控制当 UDP 流量被匹配到一个不支持 UDP 转发的策略时的行为
# - DIRECT: 回退到 DIRECT 策略(默认)
# - REJECT: 回退到 REJECT 策略
# 如果没有代理服务器支持 UDP 转发,可修改为 direct 或注释下条,但需注意同一目标主机名 TCP 请求与 UDP 请求的源地址不同所造成的隐私及安全风险
udp-policy-not-supported-behaviour = REJECT

[Replica]
# [抓取]
# ---抓取流量---
# > 过滤器
# > 隐藏 Apple 请求
# 隐藏所有发往.Apple.com和.icloud.com的请求, 0 为关闭, 1 为开启
hide-apple-request = 1
# > 隐藏崩溃追踪器请求
# Crashlytics
hide-crash-reporter-request = 1
# > 隐藏 UDP 会话
hide-udp = 1
# > 关键词过滤器
# none 关闭关键词过滤器 / whitelist 仅记录包含关键字的请求 / blacklist(仅记录不包含关键字的请求 / pattern 匹配通配符的请求
keyword-filter-type = none
# > 关键词
# keyword-filter = (null)

[Proxy]
# [代理]
# > 直连
Direct = direct
# > 拒绝
Reject = reject

[Proxy Group]
# [策略组]
# ---策略组类型---
# > select, url-test, fallback, ssid, load-balance
# - select: 具体哪个子策略将被使用,由用户界面上进行选择
# - url-test: 具体哪个子策略将被使用,通过测试到具体 URL 的访问速度选择延迟最低的策略
# url: 测试时用到的目标 URL.
# interval: 可选,秒(默认值:600s),指定在多长时间后,上次的测试结果将被抛弃
# tolerance: 可选,毫秒(默认值:100ms),只有当新的优选线路,比原优选线路的响应时间,大于该值的时候,才会触发线路变更
# timeout: 可选,秒(默认值:5s),如果某策略在该时间后依然没有完成,放弃该策略
# - fallback: 与 url-test 组基本一致,区别是只关心子策略是否可用而不关心具体延迟,然后从可用策略中选择靠前的策略,可以通过调小 timeout 参数将缓慢线路也标记为不可用
# 该类型没有 tolerance 参数
# - ssid: 具体哪个子策略将被使用,根据 Wi-FI 的 SSID/BSSID、路由 IP 地址决定
# default: 必填,默认策略
# cellular: 可选,在数据网络下的策略,若不填,那么默认策略将被使用
# - load-balance: 随机从子策略中选取一个策略使用。当配置了 url 参数时,会按照 fallback 组的行为进行可用性检查,然后仅从可用的子策略中随机选取
# url,timeout,interval
# persistent: 当 persistent=true 时,对于同一目标主机名,将尽量使用同一个策略,避免因出口 IP 不同而触发目标网站的风险控制,但当可用性改变时可能导致策略变化

# > 策略
Proxy = select, HK, US, JP, TW
Streaming = select, Direct, HK, US, JP, TW
OpenAI = select, Direct, Proxy, HK, US, JP, TW
Gamer = select, Direct, Proxy, HK, US, JP, TW
Emby = select, Direct, Proxy, HK, US, JP, TW
Final = select, Direct, Proxy
Guard = select, Reject, Direct

# > 地区节点
HK = select, policy-regex-filter=(🇭🇰)|(港)|(Hong)|(HK), no-alert=0, hidden=0, include-all-proxies=0, include-other-group=ExtSample
TW = select, policy-regex-filter=(🇨🇳)|(台)|(Tai)|(TW), no-alert=0, hidden=0, include-all-proxies=0, include-other-group=ExtSample
US = select, policy-regex-filter=(🇺🇸)|(美)|(States)|(US), no-alert=0, hidden=0, include-all-proxies=0, include-other-group=ExtSample
JP = select, policy-regex-filter=(🇯🇵)|(日)|(Japan)|(JP), no-alert=0, hidden=0, include-all-proxies=0, include-other-group=ExtSample
# > 外部节点
ExtSample = select, policy-path=https://sub.store/download/collection/MySub, update-interval=0, interval=600, timeout=3, no-alert=0, hidden=0, include-all-proxies=0

[Rule]
# [规则]
# ---域名规则---
# > 绕过企业证书过期
DOMAIN,ocsp.apple.com,Direct
# > 抖音本地分流
DOMAIN-SUFFIX,snssdk.com,Direct
DOMAIN-SUFFIX,amemv.com,Direct
# > 其它
DOMAIN-SUFFIX,local,Direct
# Sub-Store 的 Web 页面
DOMAIN-SUFFIX,vercel.app,Proxy
# 新增内置策略 NO-HYBRID,等价为 NO-HYBRID = direct, hybrid=off
# 部分服务会校验请求的来源 IP,在开启 hybrid 时有可能因为请求IP变化导致无法正常登录和使用(如招商银行),可使用 NO-HYBRID 对特定请求单独关闭 All Hybrid
DOMAIN-SUFFIX,cmbchina.com,NO-HYBRID

# ---逻辑规则---
# > AND规则:当所含规则全部匹配时, 会被触发
# HTTP3/QUIC 协议基于 UDP,部分地区 ISP 或线路 UDP 容易受到干扰或限速,屏蔽掉以阻止 HTTP 3 流量的 UDP 流量,强制回退到 TCP
# REJECT-NO-DROP 表示不使用默认的自动丢包逻辑,这样 Surge 每次都会返回 ICMP Port Unreachable,应用会立刻回退而不是等超时
AND,((PROTOCOL,UDP), (DEST-PORT,443)),REJECT-NO-DROP
# ---进程规则---
# 仅 macos 生效, ios 会自动忽略这个类型的规则
# > Proxy
PROCESS-NAME,v2ray,Direct
PROCESS-NAME,ss-local,Direct
PROCESS-NAME,UUBooster,Direct
# Download
PROCESS-NAME,aria2c,Direct
PROCESS-NAME,fdm,Direct
PROCESS-NAME,Folx,Direct
PROCESS-NAME,NetTransport,Direct
PROCESS-NAME,Thunder,Direct
PROCESS-NAME,Transmission,Direct
PROCESS-NAME,uTorrent,Direct
PROCESS-NAME,WebTorrent,Direct
PROCESS-NAME,WebTorrent Helper,Direct

# > 更新外部资源
AND,((DOMAIN,raw.githubusercontent.com), (DOMAIN-SUFFIX,github.io), (USER-AGENT,Surge/*)),Final,notification-text="External Resources Update",notification-interval=3600
# ---远程规则集---
# > Unbreak 后续规则修正
RULE-SET,https://raw.githubusercontent.com/DivineEngine/Profiles/master/Surge/Ruleset/Unbreak.list,Direct
# > Advertising 广告
RULE-SET,https://raw.githubusercontent.com/DivineEngine/Profiles/master/Surge/Ruleset/Guard/Advertising.list,Guard
DOMAIN-SET,https://raw.githubusercontent.com/DivineEngine/Profiles/master/Surge/Ruleset/Guard/AdvertisingPlus.list,Guard
# > Hijacking 运营商劫持或恶意网站
RULE-SET,https://raw.githubusercontent.com/DivineEngine/Profiles/master/Surge/Ruleset/Guard/Hijacking.list,Guard
# > Streaming 国际流媒体服务
RULE-SET,https://raw.githubusercontent.com/DivineEngine/Profiles/master/Surge/Ruleset/StreamingMedia/Streaming.list,Streaming
# > Global 全球加速
RULE-SET,https://raw.githubusercontent.com/DivineEngine/Profiles/master/Surge/Ruleset/Global.list,Proxy
# > Apple 服务
RULE-SET,https://raw.githubusercontent.com/DivineEngine/Profiles/master/Surge/Ruleset/Extra/Apple/Apple.list,Direct
# > China 中国直连
RULE-SET,https://raw.githubusercontent.com/DivineEngine/Profiles/master/Surge/Ruleset/China.list,Direct

# 防止应用循环请求
IP-CIDR,0.0.0.0/32,REJECT,no-resolve

# ---内置规则集---
# > SYSTEM
# 包含了绝大多数来自 macos 和 ios 系统本身所发送的请求
RULE-SET,SYSTEM,DIRECT

# Local Area Network & GeoIP China
# 以下规则将触发本地 DNS 解析
OR,((RULE-SET,SYSTEM), (RULE-SET,LAN), (GEOIP,CN)),DIRECT
# > Final
# DNS 查询失败走 Final 规则
FINAL,Final,dns-failed

[Host]
# DNS
# 定义本地 DNS 记录,等同于 /etc/hosts,加上了泛解析和别名支持
# Firebase Cloud Messaging
mtalk.google.com = 108.177.125.188

# Google Dl
dl.google.com = server:119.29.29.29
dl.l.google.com = server:119.29.29.29
update.googleapis.com = server:119.29.29.29

# > PlayStation
*.dl.playstation.net = server:119.29.29.29

# Router Admin Panel
amplifi.lan = server:syslib // Ubiquiti Amplifi Router
router.synology.com = server:syslib // Synology Router
sila.razer.com = server:syslib // Razer Sila Router
router.asus.com = server:syslib // Asus Router
routerlogin.net = server:syslib // Netgear Router
orbilogin.com = server:syslib // Netgear Obri Router
www.LinksysSmartWiFi.com = server:syslib // Linksys Router
LinksysSmartWiFi.com = server:syslib // Linksys Router
myrouter.local = server:syslib // Linksys Router
www.miwifi.com = server:syslib // Xiaomi Mi WiFi Router
miwifi.com = server:syslib // Xiaomi Mi WiFi Router
mediarouter.home = server:syslib // Huawei Router
tplogin.cn = server:syslib // TP-Link Router
tplinklogin.net = server:syslib // TP-Link Router
melogin.cn = server:syslib // MERCURY Router
falogin.cn = server:syslib // FAST Router

# CUSTOM HOST

[URL Rewrite]
# [Rewrite]
# 该段定义针对 HTTP 请求的 URL 重定向规则
# 建议用模块
# 两种重定向方式: header / 302
# Header 模式
# Surge 会修改发出的 http header, 必要时还会修改 Host 字段客户端将感知不到这个重定向过程, 不支持重定向到一个 HTTPS 的地址
# 302 模式
# Surge 直接简单的返回一个 302 重定向回应

[Header Rewrite]
^https?:\/\/.*\.zhihu\.com\/(question|topic) header-replace User-Agent "osee2unifiedRelease/4432 osee2unifiedReleaseVersion/7.8.0 Mozilla/5.0 (iPhone; CPU iPhone OS 14_4 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mo    bile/15E148"

[SSID Setting]
# [SSID]
# 仅 ios
# > suspend: true / false
# 在该网络下 Surge 将暂停工作,请注意,如果你在该网络下直接启动 Surge,那么 Surge 依然会工作,只有当从其他网络切换到该网络时,Surge 才会暂停
# > MCCMNC:100-200 匹配特定数据网络
# > SSID:value 特定匹配 SSID，支持通配符
# > BSSID:value 特定匹配 BSSID，支持通配符
# > ROUTER:value 特定匹配路由地址
# > TYPE:WIFI 匹配所有 WiFi 网络
# > TYPE:CELLULAR 匹配所有数据网络
# > TYPE:WIRED 匹配所有有线网络（iOS 上支持 USB 网络适配
# > cellular-fallback: 可单独控制一些 Wi-Fi 下的 all-hybrid 和 wifi-assist 行为
# - cellular-fallback=default 使用 [General] 中的 all-hybrid 和 wifi-assist 配置
# - cellular-fallback=off 关闭 all-hybrid 和 wifi-assist
# - cellular-fallback=hybrid 开启 all-hybrid 
# - cellular-fallback=wifi-assist 开启 wifi-assist
# 从上至下依次匹配,匹配到第一个结果后立刻终止
# 中国用户若使用 TFO 建议强制关闭数据网络上的 TFO,避免产生问题,然后在已测试过的网络上强制开启
# > Temporarily Suspend
# "1402" suspend=true
# > TCP Fast Open
# "1402" tfo-behaviour=force-enabled
TYPE:CELLULAR tfo-behaviour=force-disabled

[MITM]
# [MitM]
# > 跳过服务端证书验证
skip-server-cert-verify = true
# > 配置根证书
# > 证书
# > 用于 TCP 连接
tcp-connection = false
# > MITM over HTTP/2
# 使用 HTTP/2 协议进行 MITM 解密, 可在高并发下优化性能
# h2 = true
# > 主机名
# Surge 仅会解密这里指定的主机名的请求, ios 系统和某些应用有严格的安全策略, 仅信任某些特定的证书, 对这些域名启动解密可能导致问题, 如 *apple.com, *icloud.com.
# hostname = www.google.cn, api.abema.io, *.zhihu.com, -CUSTOMMitM

[Script]
# [脚本]
# 显示运行时间及MitM等功能开关状态
EDC_Surge-Panel = type=generic,script-path=https://raw.githubusercontent.com/erdongchanyo/Rules/main/Surge/Panels/EDC_Surge-Panel.js,argument=icon=crown.fill&color=#f6c970
# Flush DNS, show the DNS delay and server.
flushDNS = type=generic,timeout=10,script-path=https://raw.githubusercontent.com/zZPiglet/Task/master/asset/flushDNS.js,argument=icon=wand.and.stars.inverse&color=#3d3d5b

[Panel]
flushDNS = script-name=flushDNS,update-interval=-1
